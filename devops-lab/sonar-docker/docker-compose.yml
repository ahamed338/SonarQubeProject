# SonarQube + PostgreSQL Docker Compose Setup
# This file defines two services that work together:
# - sonarqube: Code quality analysis tool
# - postgres: Database to store SonarQube data

version: '3.8'

services:
  # PostgreSQL Database Service
  # SonarQube needs a database to store its analysis results, project metadata, etc.
  postgres:
    image: postgres:15-alpine  # Using Alpine for minimal resource usage
    container_name: sonar-postgres
    environment:
      # These environment variables configure PostgreSQL
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar123  # Change this in production!
      POSTGRES_DB: sonarqube
    volumes:
      # Persist database data to your local machine
      # This means data survives container restarts
      - postgres_data:/var/lib/postgresql/data
    ports:
      # Optional: expose PostgreSQL port if you want to connect directly
      # - "5432:5432"
    networks:
      - sonar-network
    healthcheck:
      # Check if database is ready before SonarQube starts
      test: ["CMD-SHELL", "pg_isready -U sonar"]
      interval: 5s
      timeout: 5s
      retries: 5

  # SonarQube Application Service
  sonarqube:
    image: sonarqube:community  # Community edition (free, no license needed)
    container_name: sonar-app
    depends_on:
      postgres:
        condition: service_healthy  # Wait for PostgreSQL to be healthy
    environment:
      # Connection string to PostgreSQL database
      SONAR_JDBC_URL: jdbc:postgresql://postgres:5432/sonarqube
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar123
      # SonarQube configuration
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: true  # Disable Elasticsearch bootstrap checks for local dev
    volumes:
      # Persist SonarQube configuration and data
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    ports:
      # Expose SonarQube web interface on port 9000
      # Access it at: http://localhost:9000
      # Default credentials: admin/admin (you'll be prompted to change on first login)
      - "9000:9000"
    networks:
      - sonar-network
    # Resource limits to work better on 8GB RAM MacBook
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

# Named volumes persist data outside containers
# These directories are managed by Docker and persist even if containers are deleted
volumes:
  postgres_data:
    driver: local
  sonarqube_data:
    driver: local
  sonarqube_extensions:
    driver: local
  sonarqube_logs:
    driver: local

# Network allows containers to communicate with each other
# Containers can reference each other by service name (e.g., "postgres")
networks:
  sonar-network:
    driver: bridge

